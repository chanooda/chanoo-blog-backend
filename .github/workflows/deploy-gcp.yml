name: Deploy to Google Cloud VM

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "24.x"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Build production bundle
        run: |
          pnpm install --prod --frozen-lockfile
          pnpm exec prisma generate
          pnpm build

      - name: Create .env file
        run: |
          touch .env
          jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' <<< "$SECRETS_CONTEXT" > .env
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}

      - name: Prepare deployment files
        run: |
          ls -la
          mkdir -p deploy
          cp -r dist deploy/
          cp -r generated deploy/
          cp -r prisma deploy/
          cp package.json deploy/
          cp pnpm-lock.yaml deploy/
          cp Dockerfile deploy/
          cp -a .env deploy/.
          cp deploy-blue-green.sh deploy/
          cp nginx.conf.template deploy/ || true

      - name: Create deployment archive
        run: |
          tar czf deploy.tar.gz -C deploy .

      - name: Copy changed files to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: /home/${{ secrets.GCP_VM_USER }}/blog-backend

      - name: Execute remote SSH commands using SSH key
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd /home/${{ secrets.GCP_VM_USER }}/blog-backend
            tar xzf deploy.tar.gz -C .
            rm -rf deploy deploy.tar.gz
            chmod +x deploy-blue-green.sh
            LOG_DIR=/home/${{ secrets.GCP_VM_USER }}/blog-backend/logs
            mkdir -p "$LOG_DIR"
            TS=$(date +"%Y%m%d-%H%M%S")
            LOG_FILE="$LOG_DIR/deploy-$TS.log"
            nohup bash -c "REMOVE_OLD_CONTAINER_ON_DEPLOY=true ./deploy-blue-green.sh > $LOG_FILE 2>&1" >/dev/null 2>&1 &
            echo "배포 스크립트를 백그라운드로 실행했습니다. PID: $!"

      - name: Cleanup
        if: always()
        run: |
          rm -f deploy.tar.gz
          rm -rf deploy
